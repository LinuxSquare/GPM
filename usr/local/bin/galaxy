#!/bin/bash
PKGPATH="/etc/galaxy"

source "$PKGPATH"/mirror.list
source "$PKGPATH"/inst-packages.list

PKGNAME="Galaxy"
PKGDESC="The Galaxy Package Manager written from scratch for the Galaxy Operating System"
PKGVER="1.1"
PKGDEPS=(curl tar bash xz)
AUTHOR=(LinuxSquare Dragonmaster1936)
LICENSE=(unknown)

# A Package Manager without an install function? Good Luck. :P

function install() {
if [ $# -ge 2 ]; then
    for (( k=2; k<=$#; k++ )); do
        pkg=$(cat "$PKGPATH"/packages.list | grep "${!k}")
        if [ "$pkg" ]; then
            for i in "${MIRROR[@]}"; do
                url="$i/$BRANCH/$pkg.tar.gz"
                if curl --output /dev/null --silent --fail -r 0-0 "$url"; then
                    pushd /var/cache/gpm/pkg
                    curl --silent -O "$url"
                    mkdir "$pkg"
                    tar -xzf "$pkg.tar.gz" -C $pkg
                    cd "$pkg"
                        cp -r * /
                    cd ..
                    rm -rf "$pkg"
                    popd
                    echo "$pkg" >> "$PKGPATH"/packages.list       
                    break
                else
                    echo "[$PKGNAME]: $i returned 404 on request $pkg.tar.gz"
                fi
            done
        else
            echo "[$PKGNAME]: Package ${!k} not found."
        fi
    done
        exit 0
fi
}

# Uninstall Function
# Missing Features:
# Removing unused dependencies

function uninstall() {
pkg=$(cat "$PKGPATH"/packages.list | grep "$2")
if [ "$pkg" ]; then
    for i in "${MIRROR[@]}"; do
        url="$i/$BRANCH/$pkg.tar.gz"
        if curl --output /dev/null --silent --fail -r 0-0 "$url"; then
            curl --silent -O "$url"
            tar -xzf "$pkg.tar.gz"
            pushd "$pkg"
            source software.list
            for j in "${SOFTWARE[@]}"; do
                rm -rf "$j"
            done
            popd
            sed "s/$pkg//" "$PKGPATH"/inst-packages.list > "$PKGPATH"/inst-packages.list
            rm -rf "$pkg"{,".tar.gz"}
        else
            echo "[$PKGNAME]: $i returned 404 on request $pkg.tar.gz"
        fi
    done
else
    echo "[$PKGNAME]: Package $2 not found."
fi
}

# Function to install dependencies of software and their dependencies
# Dependency-Seption! :O

function resolveDeps() {
    echo ""
}

# Well, yeah, update. Of course

function update() {
    for i in "${MIRROR[@]}"; do
        url="$i/$BRANCH/remote.list"
        if curl --output /dev/null --silent --fail -r 0-0 "$url"; then
            curl --silent -O "$url"
            for p1 in "${INSTPACKAGES[@]}"; do
                for p2 in "${REMOTE[@]}"; do
                    if [ $p1 = $p2 ]; then
                        echo "$p1 and $p2 are similar to each other" # Just a placeholder
                    fi
                done
            done
            break
        else
            echo "[$PKGNAME]: $i returned 404 on request remote.list"
        fi
    done
}

if [ $EUID -ne 0 ]; then
    echo "[$PKGNAME]: Only runnable as root"
    exit 1
else
    case $1 in
        "install")
            install
            ;;
        "remove")
            uninstall
            ;;
        "update")
            update
            ;;
    esac
fi